
#include <Adafruit_GFX.h>
#include <Adafruit_ST7735.h>
#include <SPI.h>
#include <Encoder.h>
#include <EEPROM.h>
#include <Bounce2.h>

#define DEBUG 1    // ON/OFF switch

#if DEBUG == 1
#define debug(x)   Serial.print(x)
#define debugln(x) Serial.println(x)
#else
#define debug(x)
#define debugln(x)
#endif

// OLED Display Setup
#define tftCS   10
#define tftRST   9
#define tftDC    8
Adafruit_ST7735 tft = Adafruit_ST7735(tftCS, tftDC, tftRST);

// Encoder Pins
#define pinEncoderCW     2
#define pinEncoderCCW    3
#define pinButtonParam1 A0  
#define pinButtonParam2 A1
#define pinButtonParam3 A2 

// Encoder Setup
Encoder myEnc(pinEncoderCW, pinEncoderCCW);

Bounce btnParam1 = Bounce(); 
Bounce btnParam2 = Bounce(); 
Bounce btnParam3 = Bounce(); 

// Array Definition
struct Item {
  String name;
  int params[3];
};
Item items[24];

int currentItem   = 0; // Last selected effect index
int currentParam  = 0;
bool editMode  = false;
unsigned long lastInteractionTime = 0;

// EEPROM Addresses
#define EEPROM_SIGNATURE_ADDR    0
#define EEPROM_LAST_EFFECT_ADDR  1
#define EEPROM_PARAMS_START_ADDR 2
#define EEPROM_SIGNATURE      0xA5

//
void setup() {
  // Serial for debugging
  Serial.begin(9600);

  // Initialize OLED
  tft.initR(INITR_BLACKTAB);
  tft.setRotation(1); // Horizontal mode
  tft.fillScreen(ST77XX_BLACK);

  // Configure button and encoder
  //pinMode(BUTTON_PIN, INPUT_PULLUP);  // Button with pull-up
  pinMode(pinButtonParam1, INPUT_PULLUP); // Enable internal pull-up for A0
  pinMode(pinButtonParam2, INPUT_PULLUP); // Enable internal pull-up for A1
  pinMode(pinButtonParam3, INPUT_PULLUP); // Enable internal pull-up for A2
  //
  btnParam1.attach(pinButtonParam1);
  btnParam2.attach(pinButtonParam2);
  btnParam3.attach(pinButtonParam3);

  String names[24] = {
    "CHORUS.0", "REVERB.a0", "REVERB.b0", "Tremo.a0", "Tremo.b0", "FLANGER\n  good.0", "PITCH\n   Octave.0", "DISTORT\n   fuzz.0",
    "CHORUS.1", "REVERB.a1", "REVERB.b1", "Tremo.a1", "Tremo.b1", "FLANGER.1", "Pitch\n   Octave.1", "DISTORT\n    fuzz.1",
    "CHORUS.2", "REVERB.a2", "REVERB.b2", "Tremo.a2", "Tremo.b2", "FLANGER.2", "Pitch\n   Octave.2", "DISTORT.2"
  };

  for (int i = 0; i < 24; i++) {
    items[i].name = names[i];
  }

  // Check EEPROM Signature
  if (EEPROM.read(EEPROM_SIGNATURE_ADDR) != EEPROM_SIGNATURE) {
    // Initialize EEPROM with default values if signature is missing
    for (int i = 0; i < 24; i++) {
      for (int j = 0; j < 3; j++) {
        items[i].params[j] = 100; // Default parameters
      }
    }
    currentItem = 0;            // Default to first effect
    saveParameters();           // Save all parameters to EEPROM
    saveLastSelectedEffect();   // Save initial selected effect
    EEPROM.write(EEPROM_SIGNATURE_ADDR, EEPROM_SIGNATURE); // Write signature
  } else {
    // Load all parameters and last selected effect from EEPROM
    loadParameters();
    currentItem = loadLastSelectedEffect();
  }
  // Draw the initial screen
  drawFrame();     
  //drawItem();
}

// LOOP
void loop() { 
  static long lastPosition = -999;
  long newPosition = myEnc.read() / 2; // Adjust for sensitivity
 
  // Handle encoder rotation for item selection
  if (newPosition != lastPosition) {
    currentItem = (currentItem + (newPosition > lastPosition ? 1 : -1) + 24) % 24;
    lastPosition = newPosition; // Update the last position
    //
    drawItem();
    //lastInteractionTime = millis();
  }
  
  btnParam1.update();
  if (btnParam1.fell()) {
      Serial.println("Button 1 ON");
  }
  //
    btnParam2.update();
  if (btnParam2.fell()) {
      Serial.println("Button 2 ON");
  }
  //
    btnParam3.update();
  if (btnParam3.fell()) {
      Serial.println("Button 3 ON");
  }

  
}

void drawFrame() {
  // draw details
  tft.setTextSize(1);
  tft.setTextColor(ST77XX_WHITE);
  //
  for (int i = 0; i < 3; i++) {
      int barY = 60 + i * 16;
      // draw frame
      tft.drawRect(i, i, tft.width()-i*2, tft.height() - i*2, ST77XX_YELLOW);
      tft.setCursor(10, barY);
      // print zero left of bar
      tft.print("0");
      // draw white rect around the param
      tft.drawRect(20, barY, 100, 10, ST77XX_WHITE);
  }
}

//
void drawItem() {
  // Centered Title (Effect Number and Name)
  tft.setTextColor(ST77XX_BLUE);
  tft.setTextSize(2);

  String effectText = String(currentItem + 1) + "." + items[currentItem].name;
  int textX = 10;
  // erase previous info
  tft.fillRect(5,5,150,50,tft.color565(0, 0, 0));
  // print current effect
  tft.setCursor(textX, 12);
  tft.println(effectText);

  // Parameters Display with Horizontal Bars
  tft.setTextSize(1);
  for (int i = 0; i < 3; i++) {
    uint16_t color = ST77XX_BLUE;
    if (editMode && i == currentParam) {
      color = tft.color565(0, 0, 255); // Highlighted blue
    }
    int barY = 60 + i * 16;
    
    // PARAM
    tft.setTextColor(ST77XX_WHITE);
    tft.fillRect(21, barY+1, 98, 6, tft.color565(0, 0, 0)); // erase prev. data
    tft.fillRect(21, barY+1, items[currentItem].params[i]-2, 4, color); // Horizontal blue bar
    // erase prev. percent number
    tft.fillRect(126, barY, 20, 10, tft.color565(0, 0, 0)); 
    tft.setCursor(128, barY); // Right of bar
    tft.print(items[currentItem].params[i]); // number of percents of the right
    tft.print("%");
  }
}

void drawEditMode() {
  static long lastPosition = -999;
  long newPosition = myEnc.read() / 4;

  if (newPosition != lastPosition) {
    lastPosition = newPosition;
    items[currentItem].params[currentParam] = constrain(items[currentItem].params[currentParam] + (newPosition > lastPosition ? 1 : -1), 0, 100);
  }

  drawItem(); // Refresh the screen with updated values
}

/*/
void buttonInterrupt() {
  static unsigned long lastInterruptTime = 0;
  unsigned long interruptTime = millis();

  if (interruptTime - lastInterruptTime > 200) {
    if (!editingMode) {
      editingMode = true;
      currentParam = 0;
    } else {
      currentParam = (currentParam + 1) % 3;
      if (currentParam == 0) {
        editingMode = false;
        saveParameters();           // Save updated parameters
        saveLastSelectedEffect();   // Save the last selected effect
      }
    }
    lastInteractionTime = interruptTime;
  }
  lastInterruptTime = interruptTime;
} */

void saveParameters() {
  for (int i = 0; i < 24; i++) {
    for (int j = 0; j < 3; j++) {
      int addr = EEPROM_PARAMS_START_ADDR + i * 3 + j; // Calculate address
      EEPROM.update(addr, items[i].params[j]); // Save only if value changes
    }
  }
}

void loadParameters() {
  for (int i = 0; i < 24; i++) {
    for (int j = 0; j < 3; j++) {
      int addr = EEPROM_PARAMS_START_ADDR + i * 3 + j; // Calculate address
      items[i].params[j] = EEPROM.read(addr); // Load saved parameter
    }
  }
}

void saveLastSelectedEffect() {
  EEPROM.update(EEPROM_LAST_EFFECT_ADDR, currentItem);
}

int loadLastSelectedEffect() {
  return EEPROM.read(EEPROM_LAST_EFFECT_ADDR);
}
