
#include <Adafruit_GFX.h>
#include <Adafruit_ST7735.h>
#include <SPI.h>
#include <EEPROM.h>
#include <Bounce2.h>

#define DEBUG 1    // ON/OFF switch

#if DEBUG == 1
#define debug(x)   Serial.print(x)
#define debugln(x) Serial.println(x)
#else
#define debug(x)
#define debugln(x)
#endif

// OLED Display Setup
#define tftCS   10
#define tftRST   9
#define tftDC    8
Adafruit_ST7735 tft = Adafruit_ST7735(tftCS, tftDC, tftRST);

// Encoder Pins
#define pindebouncerCW   3
#define pinEncoderCCW    2
#define pinButtonParam1 A0  
#define pinButtonParam2 A1
#define pinButtonParam3 A2 

// Encoder Setup
volatile int encoderCount = 0;
volatile int8_t position  = 0; // Tracks partial steps (0-3)

Bounce btnParam1    = Bounce(); 
Bounce btnParam2    = Bounce(); 
Bounce btnParam3    = Bounce(); 
Bounce debouncerCW  = Bounce();
Bounce debouncerCCW = Bounce();
// State Transition Table (determines direction)
const int8_t stateTable[] = {
  0, -1, 1, 0,
  1, 0, 0, -1,
  -1, 0, 0, 1,
  0, 1, -1, 0
};

// Array Definition
struct Item {
  String name;
  int params[3];
};
Item items[24];

int currentItem   = 0; // Last selected effect index
int currentParam  = 0;
bool editMode  = false;
unsigned long lastInteractionTime = 0;

// EEPROM Addresses
#define EEPROM_SIGNATURE_ADDR    0
#define EEPROM_LAST_EFFECT_ADDR  1
#define EEPROM_PARAMS_START_ADDR 2
#define EEPROM_SIGNATURE      0xA5

//
void setup() {
  // Serial for debugging
  Serial.begin(9600);

  // Initialize OLED
  tft.initR(INITR_BLACKTAB);
  tft.setRotation(1); // Horizontal mode
  tft.fillScreen(ST77XX_BLACK);

  // Configure encoder and buttons 
  pinMode(pindebouncerCW, INPUT_PULLUP);    // set up clockwise encoder rotation 
  pinMode(pinEncoderCCW, INPUT_PULLUP);   // set up ounter clockwise encoder rotation
  pinMode(pinButtonParam1, INPUT_PULLUP); // Enable internal pull-up for button on A0
  pinMode(pinButtonParam2, INPUT_PULLUP); // Enable internal pull-up for button on A1
  pinMode(pinButtonParam3, INPUT_PULLUP); // Enable internal pull-up for button on A2
  // attach bounce objects to pins
  debouncerCW.attach(pindebouncerCW);
  debouncerCW.interval(15);                   // Debounce time in ms
  debouncerCCW.attach(pinEncoderCCW);
  debouncerCCW.interval(15);                  // Debounce time in ms
  btnParam1.attach(pinButtonParam1);
  btnParam2.attach(pinButtonParam2);
  btnParam3.attach(pinButtonParam3);

  String names[24] = {
    "CHORUS.0", "REVERB.a0", "REVERB.b0", "Tremo.a0", "Tremo.b0", "FLANGER.0", "PITCH.0", "DISTORT.0",
    "CHORUS.1", "REVERB.a1", "REVERB.b1", "Tremo.a1", "Tremo.b1", "FLANGER.1", "Pitch.1", "DISTORT.1",
    "CHORUS.2", "REVERB.a2", "REVERB.b2", "Tremo.a2", "Tremo.b2", "FLANGER.2", "Pitch.2", "DISTORT.2"
  };

  for (int i = 0; i < 24; i++) {
    items[i].name = names[i];
  }

  // Check EEPROM Signature
  if (EEPROM.read(EEPROM_SIGNATURE_ADDR) != EEPROM_SIGNATURE) {
    // Initialize EEPROM with default values if signature is missing
    for (int i = 0; i < 24; i++) {
      for (int j = 0; j < 3; j++) {
        items[i].params[j] = 100; // Default parameters
      }
    }
    currentItem = 0;            // Default to first effect
    saveParameters();           // Save all parameters to EEPROM
    saveLastSelectedEffect();   // Save initial selected effect
    EEPROM.write(EEPROM_SIGNATURE_ADDR, EEPROM_SIGNATURE); // Write signature
  } else {
    // Load all parameters and last selected effect from EEPROM
    loadParameters();
    currentItem = loadLastSelectedEffect();
  }
  // Draw the initial screen
  drawFrame();     
  //drawItem();
}

// LOOP
void loop() { 
  static long lastPosition = -999;
  //  
  debouncerCW.update();
  debouncerCCW.update();
  //
  int cwState = debouncerCW.read();
  int ccwState = debouncerCCW.read();
  //
  int newPosition = (cwState << 1) | ccwState;  // Combine into 2-bit value
  // Check for state change
  if (newPosition != lastPosition) {
      // Calculate direction using state table
      int8_t direction = stateTable[(lastPosition << 2) | newPosition];
      position += direction;
      // Detect full detent (4 steps = 1 click)
      if (position >= 2) {  // 4 or 2 STEPS_PER_DETENT
          encoderCount++; position = 0;
          currentItem = (currentItem + 1 + 24) % 24;
          debugln("CW! currentItem: " + String(currentItem));
          drawItem();
      } else if (position <= -2) {
          encoderCount--; position = 0;
          //currentItem = (currentItem + (newPosition > lastPosition ? 1 : -1) + 24) % 24;
          currentItem = (currentItem - 1 + 24) % 24;
          debugln("CCW! currentItem: " + String(currentItem));
          drawItem();
      }
      //    
      lastPosition = newPosition;
  }
  //
  btnParam1.update();
  if (btnParam1.fell()) {
      debugln("Button 1 ON");
  }
  //
  btnParam2.update();
  if (btnParam2.fell()) {
      debugln("Button 2 ON");
  }
  //
  btnParam3.update();
  if (btnParam3.fell()) {
      debugln("Button 3 ON");
  }
}

void drawFrame() {
  // draw details
  tft.setTextSize(1);
  tft.setTextColor(ST77XX_WHITE);
  //
  for (int i = 0; i < 3; i++) {
      int barY = 60 + i * 16;
      // draw frame
      tft.drawRect(i, i, tft.width()-i*2, tft.height() - i*2, ST77XX_YELLOW);
      tft.setCursor(10, barY);
      // print zero left of bar
      tft.print("0");
      // draw white rect around the param
      tft.drawRect(20, barY, 100, 10, ST77XX_WHITE);
  }
}

//
void drawItem() {
  // Centered Title (Effect Number and Name)
  tft.setTextColor(ST77XX_BLUE);
  tft.setTextSize(2);

  String effectText = String(currentItem + 1) + "." + items[currentItem].name;
  int textX = 10;
  // erase previous info
  tft.fillRect(5,5,150,50,tft.color565(0, 0, 0));
  // print current effect
  tft.setCursor(textX, 12);
  tft.println(effectText);

  // Parameters Display with Horizontal Bars
  tft.setTextSize(1);
  for (int i = 0; i < 3; i++) {
    uint16_t color = ST77XX_BLUE;
    if (editMode && i == currentParam) {
      color = tft.color565(0, 0, 255); // Highlighted blue
    }
    int barY = 60 + i * 16;
    
    // PARAM
    tft.setTextColor(ST77XX_WHITE);
    tft.fillRect(21, barY+1, 98, 6, tft.color565(0, 0, 0)); // erase prev. data
    tft.fillRect(21, barY+1, items[currentItem].params[i]-2, 4, color); // Horizontal blue bar
    // erase prev. percent number
    tft.fillRect(126, barY, 20, 10, tft.color565(0, 0, 0)); 
    tft.setCursor(128, barY); // Right of bar
    tft.print(items[currentItem].params[i]); // number of percents of the right
    tft.print("%");
  }
}

void drawEditMode() {
  //static long lastPosition = -999;
  //long newPosition = myEnc.read() / 4;

  //if (newPosition != lastPosition) {
  //  lastPosition = newPosition;
  //  items[currentItem].params[currentParam] = constrain(items[currentItem].params[currentParam] + (newPosition > lastPosition ? 1 : -1), 0, 100);
 // }

  //drawItem(); // Refresh the screen with updated values
}

/*/
void buttonInterrupt() {
  static unsigned long lastInterruptTime = 0;
  unsigned long interruptTime = millis();

  if (interruptTime - lastInterruptTime > 200) {
    if (!editingMode) {
      editingMode = true;
      currentParam = 0;
    } else {
      currentParam = (currentParam + 1) % 3;
      if (currentParam == 0) {
        editingMode = false;
        saveParameters();           // Save updated parameters
        saveLastSelectedEffect();   // Save the last selected effect
      }
    }
    lastInteractionTime = interruptTime;
  }
  lastInterruptTime = interruptTime;
} */

void saveParameters() {
  for (int i = 0; i < 24; i++) {
    for (int j = 0; j < 3; j++) {
      int addr = EEPROM_PARAMS_START_ADDR + i * 3 + j; // Calculate address
      EEPROM.update(addr, items[i].params[j]); // Save only if value changes
    }
  }
}

void loadParameters() {
  for (int i = 0; i < 24; i++) {
    for (int j = 0; j < 3; j++) {
      int addr = EEPROM_PARAMS_START_ADDR + i * 3 + j; // Calculate address
      items[i].params[j] = EEPROM.read(addr); // Load saved parameter
    }
  }
}

void saveLastSelectedEffect() {
  EEPROM.update(EEPROM_LAST_EFFECT_ADDR, currentItem);
}

int loadLastSelectedEffect() {
  return EEPROM.read(EEPROM_LAST_EFFECT_ADDR);
}
